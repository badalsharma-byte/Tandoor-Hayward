document.addEventListener('DOMContentLoaded', () => { const orderType = localStorage.getItem('tandoor_order_type'); if (!orderType) { window.location.href = 'menu.php'; return; } document.getElementById('orderType').value = orderType; document.getElementById('type-label').textContent = orderType === 'pickup' ? 'Pickup' : 'Delivery'; document.getElementById('type-icon').textContent = orderType === 'pickup' ? 'üõçÔ∏è' : 'üöó'; loadCart(); setupFormLogic(); setupPaymentMethods(); }); let cart = []; let stripe, elements, cardElement; let currentOrderId = null; const CONFIG = { stripePublishableKey: 'pk_test_51MzFQaSAvKanZHOTw7fQwTQSGYD9ShjGORLZbEiWe01iV8MBhPdxhR5VEipxwPSAhu1ttah9YtSV74g203ivlrxH00ZvOUprcH', paypalClientId: 'AXRmhuAul_k1oo98JKk09TlNVxWq801j3fvPVKtN5y6zxWuJSYl8jU_Jl5InBL2-B41zCk-vkG7fPDhQ', taxRate: 0.085, apiBase: 'crm/api' }; function loadCart() { const storedCart = localStorage.getItem('tandoor_cart'); if (!storedCart) { window.location.href = 'order.php'; return; } cart = JSON.parse(storedCart); if (cart.length === 0) { window.location.href = 'order.php'; return; } renderOrderSummary(); } function getOrderTotals() { let subtotal = 0; cart.forEach(item => { subtotal += item.price * item.qty; }); const tax = subtotal * CONFIG.taxRate; const total = subtotal + tax; return { subtotal, tax, total }; } function renderOrderSummary() { const container = document.getElementById('summary-items'); const subtotalEl = document.getElementById('summary-subtotal'); const taxEl = document.getElementById('summary-tax'); const totalEl = document.getElementById('summary-total'); container.innerHTML = ''; cart.forEach(item => { const itemTotal = item.price * item.qty; const optionsStr = item.options && item.options.length > 0 ? item.options.map(o => `${o.value}`).join(', ') : ''; const div = document.createElement('div'); div.className = 'summary-item'; div.innerHTML = ` <div class="s-item-info"> <h4>${escapeHtml(item.name)}</h4> ${optionsStr ? `<div class="s-item-options">${escapeHtml(optionsStr)}</div>` : ''} <div class="s-item-qty">Qty: ${item.qty}</div> </div> <div class="s-item-price">$${itemTotal.toFixed(2)}</div> `; container.appendChild(div); }); const { subtotal, tax, total } = getOrderTotals(); subtotalEl.textContent = `$${subtotal.toFixed(2)}`; taxEl.textContent = `$${tax.toFixed(2)}`; totalEl.textContent = `$${total.toFixed(2)}`; } function setupFormLogic() { const paymentInputs = document.querySelectorAll('input[name="paymentMethod"]'); const cardContainer = document.getElementById('card-element-container'); const paypalContainer = document.getElementById('paypal-button-container'); paymentInputs.forEach(input => { input.addEventListener('change', (e) => { document.querySelectorAll('.payment-option').forEach(l => l.classList.remove('active')); e.target.closest('label').classList.add('active'); if (e.target.value === 'card') { cardContainer.classList.add('active'); paypalContainer.classList.remove('active'); } else { cardContainer.classList.remove('active'); paypalContainer.classList.add('active'); } }); }); const form = document.getElementById('checkout-form'); form.addEventListener('submit', async (e) => { e.preventDefault(); const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value; if (paymentMethod === 'card') { await handleStripePayment(); } else { alert('Please use the PayPal button to complete your order.'); } }); } function setupPaymentMethods() { stripe = Stripe(CONFIG.stripePublishableKey); elements = stripe.elements(); const style = { base: { color: '#32325d', fontFamily: '"Poppins", sans-serif', fontSmoothing: 'antialiased', fontSize: '16px', '::placeholder': { color: '#aab7c4' } }, invalid: { color: '#fa755a', iconColor: '#fa755a' } }; cardElement = elements.create('card', { style: style }); cardElement.mount('#card-element'); cardElement.on('change', function (event) { const displayError = document.getElementById('card-errors'); if (event.error) { displayError.textContent = event.error.message; } else { displayError.textContent = ''; } }); if (window.paypal) { paypal.Buttons({ createOrder: async function (data, actions) { const orderData = await createOrderInSystem('paypal'); if (!orderData.success) { throw new Error('Failed to create order'); } currentOrderId = orderData.order_id; const { total } = getOrderTotals(); return actions.order.create({ purchase_units: [{ reference_id: orderData.order_id.toString(), amount: { value: total.toFixed(2) } }] }); }, onApprove: async function (data, actions) { return actions.order.capture().then(async function (details) { try { const response = await fetch(`${CONFIG.apiBase}/verify-paypal.php`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_id: currentOrderId, paypal_order_id: data.orderID }) }); const result = await response.json(); if (result.success) { completeOrder(details.payer.name.given_name); } else { alert('Payment verification failed. Please contact support.'); } } catch (err) { console.error('PayPal verification error:', err); completeOrder(details.payer.name.given_name); } }); }, onError: function (err) { console.error('PayPal error:', err); alert('PayPal payment failed. Please try again.'); } }).render('#paypal-button-container'); } } function getFormData() { const form = document.getElementById('checkout-form'); const formData = new FormData(form); return { customer_name: `${formData.get('firstName') || ''} ${formData.get('lastName') || ''}`.trim(), customer_email: formData.get('email') || '', customer_phone: formData.get('phone') || '', order_type: formData.get('orderType') || 'pickup', pickup_time: formData.get('pickupTime') || '', delivery_address: formData.get('address') || '', delivery_city: formData.get('city') || '', delivery_zip: formData.get('zip') || '', }; } async function createOrderInSystem(paymentMethod) { const customerData = getFormData(); const { subtotal, tax, total } = getOrderTotals(); const orderData = { ...customerData, items: cart, subtotal: subtotal.toFixed(2), tax: tax.toFixed(2), total: total.toFixed(2), payment_method: paymentMethod }; try { const response = await fetch(`${CONFIG.apiBase}/create-order.php`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) }); return await response.json(); } catch (err) { console.error('Order creation error:', err); return { success: false, error: err.message }; } } async function handleStripePayment() { const submitBtn = document.getElementById('place-order-btn'); submitBtn.disabled = true; submitBtn.textContent = 'Processing...'; try { const orderResult = await createOrderInSystem('card'); if (!orderResult.success) { throw new Error(orderResult.error || 'Failed to create order'); } currentOrderId = orderResult.order_id; const { total } = getOrderTotals(); const customerData = getFormData(); const intentResponse = await fetch(`${CONFIG.apiBase}/create-payment-intent.php`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_id: currentOrderId, amount: total, customer_email: customerData.customer_email }) }); const intentResult = await intentResponse.json(); if (!intentResult.success) { console.warn('Payment intent failed, using fallback:', intentResult.error); await handleFallbackPayment(); return; } const { error, paymentIntent } = await stripe.confirmCardPayment(intentResult.clientSecret, { payment_method: { card: cardElement, billing_details: { name: customerData.customer_name, email: customerData.customer_email } } }); if (error) { throw new Error(error.message); } if (paymentIntent.status === 'succeeded') { await fetch(`${CONFIG.apiBase}/confirm-payment.php`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_id: currentOrderId, payment_method: 'card', payment_id: paymentIntent.id }) }); completeOrder(); } } catch (err) { console.error('Payment error:', err); const errorElement = document.getElementById('card-errors'); errorElement.textContent = err.message; submitBtn.disabled = false; submitBtn.textContent = 'Place Order'; } } async function handleFallbackPayment() { const { token, error } = await stripe.createToken(cardElement); if (error) { const errorElement = document.getElementById('card-errors'); errorElement.textContent = error.message; const submitBtn = document.getElementById('place-order-btn'); submitBtn.disabled = false; submitBtn.textContent = 'Place Order'; } else { console.log('Stripe Token (fallback):', token.id); if (currentOrderId) { await fetch(`${CONFIG.apiBase}/confirm-payment.php`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_id: currentOrderId, payment_method: 'card', payment_id: token.id }) }); } completeOrder(); } } function completeOrder(customerName = '') { const orderType = localStorage.getItem('tandoor_order_type') || 'pickup'; const { subtotal, tax, total } = getOrderTotals(); const orderItems = [...cart]; localStorage.removeItem('tandoor_cart'); localStorage.removeItem('tandoor_order_type'); const greeting = customerName ? customerName : 'Guest'; const pickupTime = document.getElementById('pickup-time')?.value || 'ASAP'; const pickupTimeDisplay = pickupTime === 'asap' ? 'ASAP (25-35 mins)' : pickupTime; let itemsHtml = ''; orderItems.forEach(item => { const itemTotal = item.price * item.qty; const optionsStr = item.options && item.options.length > 0 ? `<div style="font-size: 0.85rem; color: #888;">${item.options.map(o => o.value).join(', ')}</div>` : ''; itemsHtml += ` <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;"> <div> <div style="font-weight: 500;">${escapeHtml(item.name)} x${item.qty}</div> ${optionsStr} </div> <div style="font-weight: 500;">$${itemTotal.toFixed(2)}</div> </div> `; }); document.querySelector('.checkout-container').innerHTML = ` <div style="grid-column: 1 / -1; max-width: 500px; margin: 0 auto; padding: 40px 20px;"> <!-- Receipt Card --> <div style="background: #fff; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden;"> <!-- Receipt Header --> <div style="background: linear-gradient(135deg, #1a1a1a, #333); padding: 30px; text-align: center;"> <img src="./assets/images/logo (2).png" alt="Tandoor" style="height: 60px; margin-bottom: 15px;"> <div style="color: #F5A623; font-size: 0.85rem; letter-spacing: 2px; text-transform: uppercase;">Order Confirmation</div> </div> <!-- Order Status --> <div style="background: #F5A623; color: #fff; padding: 15px; text-align: center;"> <div style="font-size: 1.5rem; margin-bottom: 5px;">‚úì</div> <div style="font-weight: 600; font-size: 1.1rem;">Order Placed Successfully!</div> </div> <!-- Receipt Body --> <div style="padding: 25px;"> <!-- Order Info --> <div style="text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px dashed #eee;"> ${currentOrderId ? `<div style="font-size: 0.9rem; color: #888;">Order #${currentOrderId}</div>` : ''} <div style="font-size: 1.2rem; font-weight: 600; color: #1a1a1a; margin-top: 5px;">Thank you, ${escapeHtml(greeting)}!</div> </div> <!-- Pickup Info --> <div style="background: #f9f8f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;"> <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;"> <span style="font-size: 1.2rem;">${orderType === 'pickup' ? 'üõçÔ∏è' : 'üöó'}</span> <span style="font-weight: 600; text-transform: capitalize;">${orderType}</span> </div> <div style="font-size: 0.9rem; color: #666;"> <div style="margin-bottom: 5px;">‚è±Ô∏è ${pickupTimeDisplay}</div> <div>üìç 27167 Mission Blvd, Hayward, CA 94544</div> </div> </div> <!-- Order Items --> <div style="margin-bottom: 20px;"> <div style="font-weight: 600; margin-bottom: 10px; color: #1a1a1a;">Order Details</div> ${itemsHtml} </div> <!-- Totals --> <div style="border-top: 2px solid #eee; padding-top: 15px;"> <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #666;"> <span>Subtotal</span> <span>$${subtotal.toFixed(2)}</span> </div> <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #666;"> <span>Tax (8.5%)</span> <span>$${tax.toFixed(2)}</span> </div> <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700; color: #1a1a1a; padding-top: 10px; border-top: 1px solid #eee;"> <span>Total</span> <span style="color: #F5A623;">$${total.toFixed(2)}</span> </div> </div> </div> <!-- Receipt Footer --> <div style="background: #f9f8f6; padding: 20px; text-align: center; border-top: 1px solid #eee;"> <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 5px;">Tandoor Indian Restaurant</div> <div style="font-size: 0.85rem; color: #666; margin-bottom: 3px;">27167 Mission Blvd, Hayward, CA 94544</div> <div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">(510) 555-0123</div> <div style="font-size: 0.8rem; color: #888;">A confirmation email has been sent to your inbox.</div> </div> </div> <!-- Action Buttons --> <div style="text-align: center; margin-top: 25px;"> <a href="index.php" style="display: inline-block; background: #F5A623; color: #fff; padding: 15px 40px; text-decoration: none; border-radius: 50px; font-weight: 600; transition: all 0.3s;">Return Home</a> </div> </div> `; } function escapeHtml(text) { if (!text) return ''; return text .replace(/&/g, "&amp;") .replace(/</g, "&lt;") .replace(/>/g, "&gt;") .replace(/"/g, "&quot;") .replace(/'/g, "&#039;"); } 